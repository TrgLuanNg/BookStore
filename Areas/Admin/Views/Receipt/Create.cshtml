@{ ViewData["Title"] = "Tạo Phiếu Nhập Hàng"; }

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-primary fw-bold">📥 Tạo Phiếu Nhập Hàng</h2>
        <a href="/Admin/Receipt/Index" class="btn btn-secondary">Quay lại</a>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white fw-bold">Thông tin chung</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="fw-bold">Nhà cung cấp</label>
                        <select id="SupplierId" class="form-select">
                            <option value="">-- Chọn NCC --</option>
                            @if(ViewBag.Suppliers != null) {
                                foreach(var item in ViewBag.Suppliers) {
                            <option value="@item.Id">@item.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Ghi chú</label>
                        <textarea id="Notes" class="form-control" rows="3" placeholder="Ghi chú nhập hàng..."></textarea>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng số lượng:</span>
                        <span class="fw-bold" id="lblTotalQty">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Tổng tiền:</span>
                        <span class="fw-bold text-danger fs-5" id="lblTotalPrice">0 đ</span>
                    </div>
                    <button class="btn btn-primary w-100 py-2" onclick="submitReceipt()">
                        <i class="fas fa-save me-2"></i>LƯU PHIẾU
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Chi tiết hàng nhập</span>
                    <button class="btn btn-sm btn-success" onclick="addRow()">
                        <i class="fas fa-plus"></i> Thêm sách
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered table-striped mb-0" id="tblDetails">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 40%">Tên sách (Chọn từ kho)</th>
                                <th style="width: 10%">Tồn hiện tại</th>
                                <th style="width: 15%">Số lượng nhập</th>
                                <th style="width: 20%">Giá nhập (VNĐ)</th>
                                <th style="width: 15%">Thành tiền</th>
                                <th style="width: 5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div id="empty-msg" class="text-center py-5 text-muted">
                        Chưa có cuốn sách nào được chọn. Nhấn nút <b>+ Thêm sách</b> ở góc trên.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Biến lưu danh sách sách để nạp vào dropdown
    var bookList = [];

    // 1. Khi trang tải xong -> Gọi API lấy sách
    $(document).ready(function () {
        $.get('/Admin/Product/GetAllForReceipt', function (res) {
            if (res.success) {
                bookList = res.data;
                // Thêm sẵn 1 dòng để nhập cho tiện
                addRow();
            } else {
                alert("Lỗi tải danh sách sách!");
            }
        });
    });

    // 2. Hàm thêm dòng mới
    function addRow() {
        $('#empty-msg').hide();

        // Tạo option cho select
        let options = '<option value="">-- Chọn sách --</option>';
        bookList.forEach(b => {
            options += `<option value="${b.id}" data-price="${b.price}" data-stock="${b.quantity}">${b.name}</option>`;
        });

        let tr = `
            <tr class="item-row">
                <td>
                    <select class="form-select book-select" onchange="onBookChange(this)">${options}</select>
                </td>
                <td class="text-center stock-display text-muted">-</td>
                <td>
                    <input type="number" class="form-control qty-input" value="1" min="1" onchange="calcTotal()">
                </td>
                <td>
                    <input type="number" class="form-control price-input" value="0" min="0" onchange="calcTotal()">
                </td>
                <td class="fw-bold text-end row-total">0</td>
                <td class="text-center">
                    <button class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
        $('#tblDetails tbody').append(tr);
    }

    // 3. Khi chọn sách -> Tự điền giá bán hiện tại làm giá nhập gợi ý
    function onBookChange(el) {
        let option = $(el).find(':selected');
        let row = $(el).closest('tr');

        // Lấy dữ liệu từ attribute data-
        let stock = option.data('stock');
        let price = option.data('price'); // Giá bán hiện tại

        if (option.val()) {
            row.find('.stock-display').text(stock);
            row.find('.price-input').val(price); // Gợi ý giá nhập = giá bán (user có thể sửa)
        } else {
            row.find('.stock-display').text('-');
            row.find('.price-input').val(0);
        }
        calcTotal();
    }

    // 4. Xóa dòng
    function removeRow(btn) {
        $(btn).closest('tr').remove();
        if ($('#tblDetails tbody tr').length === 0) $('#empty-msg').show();
        calcTotal();
    }

    // 5. Tính toán tổng tiền
    function calcTotal() {
        let totalQty = 0;
        let totalPrice = 0;

        $('.item-row').each(function () {
            let qty = parseInt($(this).find('.qty-input').val()) || 0;
            let price = parseFloat($(this).find('.price-input').val()) || 0;
            let rowSum = qty * price;

            $(this).find('.row-total').text(rowSum.toLocaleString('vi-VN'));

            totalQty += qty;
            totalPrice += rowSum;
        });

        $('#lblTotalQty').text(totalQty);
        $('#lblTotalPrice').text(totalPrice.toLocaleString('vi-VN') + " đ");
    }

    // 6. Gửi dữ liệu về Server
    function submitReceipt() {
        let supplierId = $('#SupplierId').val();
        if (!supplierId) { alert("Vui lòng chọn Nhà cung cấp!"); return; }

        let details = [];
        let hasError = false;

        $('.item-row').each(function () {
            let bookId = $(this).find('.book-select').val();
            let qty = $(this).find('.qty-input').val();
            let price = $(this).find('.price-input').val();

            if (!bookId) return; // Bỏ qua dòng chưa chọn sách

            if (qty <= 0) { hasError = true; alert("Số lượng phải lớn hơn 0"); return false; }

            details.push({
                ProductId: parseInt(bookId),
                Quantity: parseInt(qty),
                Price: parseFloat(price)
            });
        });

        if (hasError) return;
        if (details.length === 0) { alert("Chưa có cuốn sách nào để nhập!"); return; }

        let data = {
            SupplierId: parseInt(supplierId),
            Notes: $('#Notes').val(),
            Details: details
        };

        // Gửi AJAX
        $.ajax({
            url: '/Admin/Receipt/Create',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                if (res.success) {
                    alert("Nhập hàng thành công! Kho đã được cập nhật.");
                    window.location.href = '/Admin/Receipt/Index';
                } else {
                    alert("Lỗi: " + res.message);
                }
            },
            error: function () {
                alert("Lỗi kết nối server!");
            }
        });
    }
</script>