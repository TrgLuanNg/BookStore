@model IEnumerable<BookStore.Models.Book>
    @{ ViewData["Title"] = "Quản lý sản phẩm"; }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">📦 Quản lý sản phẩm</h2>
        <button class="btn btn-success shadow-sm" onclick="openCreateModal()">
            <i class="fas fa-plus-circle me-2"></i>Thêm sản phẩm mới
        </button>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="bg-light text-secondary">
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Hình ảnh</th>
                        <th>Tên sách</th>
                        <th>Giá bán</th>
                        <th>Tồn kho</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                    <tr id="row_@item.Id">
                        <td class="ps-4 fw-bold">#@item.Id</td>
                        <td>
                            <img src="/@item.ImagePath" onerror="this.src='https://via.placeholder.com/50'"
                                 width="50" height="70" class="rounded shadow-sm" style="object-fit:cover">
                        </td>
                        <td>
                            <div class="fw-bold text-dark">@item.Name</div>
                            <small class="text-muted">NXB ID: @item.PublisherId</small>
                        </td>
                        <td class="text-danger fw-bold">@item.Price.ToString("#,##0") đ</td>
                        <td>
                            @if (item.Quantity > 0)
                                {
                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                                Còn @item.Quantity cuốn
                            </span>
                                }
                                else
                                {
                            <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill">Hết hàng</span>
                                }
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-primary me-1" title="Sửa" onclick="openEditModal(@item.Id)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(@item.Id)" title="Xóa">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p>Chưa có sản phẩm nào trong kho.</p>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Thêm sản phẩm mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Tên sách <span class="text-danger">*</span></label>
                                <input type="text" id="p_name" class="form-control" placeholder="Nhập tên sách..." required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Giá bán</label>
                                <div class="input-group">
                                    <input type="number" id="p_price" class="form-control" value="0">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Số lượng ban đầu</label>
                                <input type="number" id="p_qty" class="form-control" value="10">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold">Đường dẫn ảnh (URL/Path)</label>
                                <input type="text" id="p_image" class="form-control" placeholder="Ví dụ: images/sach-a.jpg">
                                <small class="text-muted">Tạm thời nhập đường dẫn text. Tính năng upload ảnh sẽ làm sau.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Nhà xuất bản</label>
                                <select id="p_publisher" class="form-select">
                                    <option value="">Đang tải...</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Tác giả (Chọn nhiều)</label>
                                <select id="p_authors" class="form-select" multiple style="height: 100px">
                                </select>
                                <small class="text-xs text-muted">Giữ Ctrl để chọn nhiều</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Thể loại (Chọn nhiều)</label>
                                <select id="p_categories" class="form-select" multiple style="height: 100px">
                                </select>
                                <small class="text-xs text-muted">Giữ Ctrl để chọn nhiều</small>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold">Mô tả</label>
                                <textarea id="p_desc" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreate()">Lưu sản phẩm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var myModal;
        var isEditMode = false; // Cờ đánh dấu đang Thêm hay Sửa
        var currentEditingId = 0;

        $(document).ready(function () {
            // Khởi tạo modal object
            var modalEl = document.getElementById('createModal');
            if (modalEl) myModal = new bootstrap.Modal(modalEl);
        });

        // 1. Hàm load dữ liệu Dropdown (dùng chung cho cả Thêm và Sửa)
        function loadAuxData(callback) {
            $.get('/Admin/Product/GetAuxData', function (res) {
                // NXB
                let pubHtml = '<option value="">-- Chọn NXB --</option>';
                if (res.publishers) {
                    res.publishers.forEach(p => { pubHtml += `<option value="${p.id}">${p.name}</option>`; });
                }
                $('#p_publisher').html(pubHtml);

                // Tác giả
                let authHtml = '';
                if (res.authors) {
                    res.authors.forEach(a => { authHtml += `<option value="${a.id}">${a.name}</option>`; });
                }
                $('#p_authors').html(authHtml);

                // Thể loại
                let catHtml = '';
                if (res.categories) {
                    res.categories.forEach(c => { catHtml += `<option value="${c.id}">${c.name}</option>`; });
                }
                $('#p_categories').html(catHtml);

                // Nhà cung cấp (Thêm mới)
                let supHtml = '<option value="">-- Chọn NCC --</option>';
                if (res.suppliers) {
                    res.suppliers.forEach(s => { supHtml += `<option value="${s.id}">${s.name}</option>`; });
                }
                $('#p_supplier').html(supHtml);

                if (callback) callback();
            });
        }

        // 2. Mở Modal Thêm Mới
        function openCreateModal() {
            isEditMode = false;
            currentEditingId = 0;

            // Reset form
            $('#createForm')[0].reset();
            $('#p_image').val('images/product/image_1.jpg'); // Giá trị mặc định
            $('.modal-title').html('<i class="fas fa-plus me-2"></i>Thêm sản phẩm mới');

            loadAuxData(function () {
                myModal.show();
            });
        }

        // 3. Mở Modal Sửa (Load dữ liệu cũ lên)
        function openEditModal(id) {
            isEditMode = true;
            currentEditingId = id;

            loadAuxData(function () {
                // Gọi API lấy chi tiết sách
                $.get('/Admin/Product/GetById?id=' + id, function (res) {
                    if (res.success) {
                        let d = res.data;

                        // Điền dữ liệu vào form
                        $('#p_name').val(d.name);
                        $('#p_price').val(d.price);
                        $('#p_qty').val(d.quantity);
                        $('#p_image').val(d.imagePath);
                        $('#p_desc').val(d.description);

                        // Chọn đúng các Dropdown đơn
                        $('#p_publisher').val(d.publisherId);
                        $('#p_supplier').val(d.supplierId); // <--- Đã thêm dòng này để chọn lại NCC cũ

                        // Điền tác giả và thể loại (Select multiple)
                        if (res.authors) $('#p_authors').val(res.authors);
                        if (res.categories) $('#p_categories').val(res.categories);

                        $('.modal-title').html('<i class="fas fa-edit me-2"></i>Cập nhật sản phẩm');
                        myModal.show();
                    } else {
                        alert(res.message);
                    }
                });
            });
        }

        // 4. Gửi dữ liệu (Submit)
        function submitCreate() {
            // Thu thập dữ liệu
            let formData = new FormData();

            // Nếu đang sửa thì phải gửi kèm Id
            if (isEditMode) {
                formData.append("Id", currentEditingId);
            }

            formData.append("Name", $('#p_name').val());
            formData.append("Price", $('#p_price').val());
            formData.append("Quantity", $('#p_qty').val());
            formData.append("ImagePath", $('#p_image').val());

            // Dropdown đơn
            formData.append("PublisherId", $('#p_publisher').val());
            formData.append("SupplierId", $('#p_supplier').val());

            // Mô tả (Đã bỏ comment để lưu mô tả)
            formData.append("Description", $('#p_desc').val());

            // Lấy danh sách ID tác giả (multiple select)
            let selectedAuthors = $('#p_authors').val();
            if (selectedAuthors) {
                selectedAuthors.forEach(id => formData.append("authorIds", id));
            }

            // Lấy danh sách ID thể loại
            let selectedCats = $('#p_categories').val();
            if (selectedCats) {
                selectedCats.forEach(id => formData.append("categoryIds", id));
            }

            let url = isEditMode ? '/Admin/Product/Edit' : '/Admin/Product/Create';

            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.success) {
                        alert(res.message);
                        location.reload(); // Tải lại trang để thấy dữ liệu mới
                    } else {
                        alert("Lỗi: " + res.message);
                    }
                },
                error: function () {
                    alert("Đã có lỗi xảy ra khi gọi server!");
                }
            });
        }

        // 5. Xóa sản phẩm
        function deleteProduct(id) {
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này không?")) {
                $.post('/Admin/Product/Delete', { id: id }, function (res) {
                    if (res.success) {
                        $('#row_' + id).remove(); // Xóa dòng trong bảng HTML ngay lập tức
                    } else {
                        alert("Xóa thất bại. Có thể sản phẩm không tồn tại hoặc lỗi server.");
                    }
                });
            }
        }
    </script>