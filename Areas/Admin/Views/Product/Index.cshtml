@model IEnumerable<BookStore.Models.Book>
    @{ ViewData["Title"] = "Quản lý sản phẩm"; }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">📦 Quản lý sản phẩm</h2>
        <button class="btn btn-success shadow-sm" onclick="openCreateModal()">
            <i class="fas fa-plus-circle me-2"></i>Thêm sản phẩm mới
        </button>
    </div>

    <div class="card shadow border-0">
        <div class="card-body p-0">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="bg-light text-secondary">
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Hình ảnh</th>
                        <th>Tên sách</th>
                        <th>Giá bán</th>
                        <th>Tồn kho</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                    <tr id="row_@item.Id">
                        <td class="ps-4 fw-bold">#@item.Id</td>
                        <td>
                            <img src="/@item.ImagePath" onerror="this.src='https://via.placeholder.com/50'"
                                 width="50" height="70" class="rounded shadow-sm" style="object-fit:cover">
                        </td>
                        <td>
                            <div class="fw-bold text-dark">@item.Name</div>
                            <small class="text-muted">NXB ID: @item.PublisherId</small>
                        </td>
                        <td class="text-danger fw-bold">@item.Price.ToString("#,##0") đ</td>
                        <td>
                            @if (item.Quantity > 0)
                                {
                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                                Còn @item.Quantity cuốn
                            </span>
                                }
                                else
                                {
                            <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill">Hết hàng</span>
                                }
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-primary me-1" title="Sửa" onclick="openEditModal(@item.Id)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(@item.Id)" title="Xóa">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p>Chưa có sản phẩm nào trong kho.</p>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Thêm sản phẩm mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Tên sách <span class="text-danger">*</span></label>
                                <input type="text" id="p_name" class="form-control" placeholder="Nhập tên sách..." required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Giá bán</label>
                                <div class="input-group">
                                    <input type="number" id="p_price" class="form-control" value="0">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Số lượng ban đầu</label>
                                <input type="number" id="p_qty" class="form-control" value="10">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold">Đường dẫn ảnh (URL/Path)</label>
                                <input type="text" id="p_image" class="form-control" placeholder="Ví dụ: images/sach-a.jpg">
                                <small class="text-muted">Tạm thời nhập đường dẫn text. Tính năng upload ảnh sẽ làm sau.</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nhà xuất bản</label>
                                <select id="p_publisher" class="form-select">
                                    <option value="">Đang tải...</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nhà cung cấp</label> <select id="p_supplier" class="form-select">
                                    <option value="">Đang tải...</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tác giả (Chọn nhiều)</label>
                                <select id="p_authors" class="form-select" multiple style="height: 100px">
                                </select>
                                <small class="text-xs text-muted">Giữ Ctrl để chọn nhiều</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Thể loại (Chọn nhiều)</label>
                                <select id="p_categories" class="form-select" multiple style="height: 100px">
                                </select>
                                <small class="text-xs text-muted">Giữ Ctrl để chọn nhiều</small>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold">Mô tả</label>
                                <textarea id="p_desc" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreate()">Lưu sản phẩm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var myModal;
        // Khởi tạo Modal khi trang load xong
        $(document).ready(function () {
            var modalEl = document.getElementById('createModal');
            if (modalEl) myModal = new bootstrap.Modal(modalEl);
        });

        // Hàm mở Modal và tải dữ liệu Dropdown
        function openCreateModal() {
            // Reset form để nhập mới
            $('#createForm')[0].reset();

            // Gọi API lấy danh sách NXB, Tác giả, Thể loại
            $.get('/Admin/Product/GetAuxData', function (res) {
                // 1. Điền Nhà xuất bản
                let pubHtml = '<option value="">-- Chọn NXB --</option>';
                if (res.publishers) res.publishers.forEach(p => { pubHtml += `<option value="${p.id}">${p.name}</option>`; });
                $('#p_publisher').html(pubHtml);

                // 2. Điền Tác giả
                let authHtml = '';
                if (res.authors) res.authors.forEach(a => { authHtml += `<option value="${a.id}">${a.name}</option>`; });
                $('#p_authors').html(authHtml);

                // 3. Điền Thể loại
                let catHtml = '';
                if (res.categories) res.categories.forEach(c => { catHtml += `<option value="${c.id}">${c.name}</option>`; });
                $('#p_categories').html(catHtml);

                // Hiện Modal
                if (myModal) myModal.show();
            });
        }

        // Hàm Gửi dữ liệu về Server (Thêm mới)
        function submitCreate() {
            // Lấy dữ liệu từ form
            let bookData = {
                Name: $('#p_name').val(),
                Price: parseFloat($('#p_price').val()),
                Quantity: parseInt($('#p_qty').val()),
                ImagePath: $('#p_image').val() || 'images/default.jpg',
                Description: $('#p_desc').val(),
                PublisherId: parseInt($('#p_publisher').val()),
                SupplierId: 1 // Tạm fix cứng
            };

            $.post('/Admin/Product/Create', bookData, function (res) {
                if (res.success) {
                    alert(res.message);
                    location.reload();
                } else {
                    alert("Lỗi: " + res.message);
                }
            }).fail(function () {
                alert("Lỗi kết nối server!");
            });
        }

        // --- HÀM XÓA (ĐOẠN NÀY ĐANG THIẾU Ở FILE CỦA BẠN) ---
        function deleteProduct(id) {
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này không?")) {
                $.post('/Admin/Product/Delete', { id: id }, function (res) {
                    if (res.success) {
                        // Xóa dòng tương ứng trên bảng ngay lập tức
                        $('#row_' + id).fadeOut(300, function () { $(this).remove(); });
                    } else {
                        alert("Xóa thất bại: " + (res.message || "Lỗi không xác định"));
                    }
                }).fail(function () {
                    alert("Không thể xóa! Có thể sách này đang có trong đơn hàng.");
                });
            }
        }
    </script>